<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>é¢˜åº“è‡ªæµ‹-è‡ªè¡Œå¯¼å…¥</title>

<style>
:root{
  --bg:#f5f7fb;--card:#ffffff;--text:#0f172a;
  --primary:#4f46e5;--ok:#16a34a;--bad:#dc2626;
  --muted:#64748b;--border:#e2e8f0;
}
body.dark{
  --bg:#0b1220;--card:#111827;--text:#e5e7eb;
  --muted:#94a3b8;--border:#1f2937;
}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
}
.container{max-width:980px;margin:auto;padding:16px}
.card{
  background:var(--card);border-radius:20px;padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.08)
}
.hidden{display:none}

/* å¯¼å…¥åŒº */
.drag{
  border:2px dashed var(--muted);
  border-radius:16px;
  padding:16px;
  text-align:center;
  margin-bottom:16px;
}

/* Header */
.header{
  display:flex;justify-content:space-between;align-items:center;
}
.header-left{
  display:flex;align-items:center;gap:12px;
}
.stats{font-weight:600}
#fileName{font-weight:600;color:var(--muted);}

/* èœå• */
.menu{position:relative}
.menu-btn{
  background:none;
  font-size:22px;
  color:var(--text);
  border: none;
  cursor: pointer;
  padding: 4px 8px;
}
.menu-list{
  position:absolute;
  right:0; top:38px;
  background:var(--card);
  border-radius:14px;
  box-shadow:0 15px 35px rgba(0,0,0,.25);
  padding:8px;
  min-width:200px;
  opacity:0; transform:scale(.95);
  pointer-events:none; transition:.18s ease;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index: 10;
}
.menu-list.show{
  opacity:1; transform:scale(1); pointer-events:auto;
}
.menu-list a,
.menu-list button,
.menu-list label{
  width:100%;
  text-align:left;
  background:none;
  padding:10px 12px;
  border-radius:10px;
  color:var(--text);
  border: none;
  font-size: 16px;
  cursor: pointer;
}
.menu-list a:hover,
.menu-list button:hover{
  background:rgba(79,70,229,.1);
}

/* é¢˜ç›® & å›¾ç‰‡å®¹å™¨æ ·å¼ */
.question{
  margin-top:18px;
  font-size:22px;
  font-weight:600;
  line-height:1.65;
}
/* å›¾ç‰‡å®¹å™¨æ ¸å¿ƒæ ·å¼ */
.img-container{
  margin: 12px 0;
  width: 100%;
}
.img-toggle-btn{
  background: rgba(79,70,229,.1);
  color: var(--primary);
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 16px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
body.dark .img-toggle-btn{
  background: rgba(79,70,229,.2);
}
.img-toggle-btn:hover{
  background: rgba(79,70,229,.2);
}
body.dark .img-toggle-btn:hover{
  background: rgba(79,70,229,.3);
}
/* å›¾ç‰‡å“åº”å¼æ ·å¼ï¼Œé˜²æ­¢æº¢å‡º */
.question-img{
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 8px;
  border: 1px solid var(--border);
}

.options{
  margin-top:16px;
  display:flex;flex-direction:column;gap:12px
}
.option{
  padding:14px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:18px;
  cursor:pointer
}
.option.correct{
  border-left:6px solid var(--ok);
  background:rgba(22,163,74,.08)
}
body.dark .option.correct{
  background:rgba(22,163,74,.12)
}
.option.wrong{
  border-left:6px solid var(--bad);
  background:rgba(220,38,38,.08)
}

/* Footer */
.footer{
  display:flex;justify-content:space-between;margin-top:22px
}
button{
  min-height:44px;
  border:none;border-radius:14px;
  padding:8px 16px;
  background:var(--primary);color:#fff;
  cursor: pointer;
}
button.secondary{background:#64748b}

@media(max-width:640px){
  .question{font-size:20px}
  .option{font-size:17px}
  .img-toggle-btn{font-size:14px}
}
</style>
</head>
<body>
<div class="container">

<!-- é¢˜åº“å¯¼å…¥åŒº -->
<div class="drag" id="loader">
  ğŸ“ æ‹–æ‹½ TXT é¢˜åº“ï¼ˆJSON å†…å®¹ï¼‰<br><br>
  <button onclick="fileInput.click()">ç‚¹å‡»ä¸Šä¼ </button>
  <input type="file" id="fileInput" accept=".txt" hidden>
</div>

<div class="card">
  <div class="header">
    <div class="header-left">
      <span id="fileName">æœªåŠ è½½æ–‡ä»¶</span>
      <div class="stats" id="stats">æœªåŠ è½½é¢˜åº“</div>
    </div>

    <div class="menu">
      <button class="menu-btn" onclick="toggleMenu(event)">â‹®</button>
      <div class="menu-list" id="menuList">
        <a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a>
        <button onclick="togglePreview()">ğŸ‘€ å…¨å±€é¢„è§ˆ</button>
        <button onclick="exportReview()">ğŸ’¾ å¯¼å‡ºå¤ä¹ åŒ…</button>
        <button onclick="importReview()">ğŸ“¥ å¯¼å…¥å¤ä¹ åŒ…</button>
        <label><input type="checkbox" id="autoNext" checked> ç­”å¯¹è‡ªåŠ¨ä¸‹ä¸€é¢˜</label>
        <label><input type="checkbox" id="darkMode"> å¤œé—´æ¨¡å¼</label>
        <button onclick="toggleLoader()">ğŸ“ é¢˜åº“å¯¼å…¥</button>
        <button onclick="toggleWrong()">âŒ é”™é¢˜æ¨¡å¼</button>
        <!-- æ–°å¢è·³è½¬åŠŸèƒ½ -->
<div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
  <input type="number" id="jumpInputMenu" min="1" placeholder="é¢˜å·" style="width:60px; padding:2px;"/>
  <button onclick="jumpToMenu()">è·³è½¬</button>
</div>
      </div>
    </div>
  </div>

  <div id="content"></div>

  <div class="footer">
    <button class="secondary" onclick="prev()">ä¸Šä¸€é¢˜</button>
    <button onclick="next()">ä¸‹ä¸€é¢˜</button>
  </div>
</div>

</div>

<!-- å¤ä¹ åŒ…å¯¼å…¥ä¸“ç”¨ -->
<input type="file" id="reviewInput" accept=".txt" hidden>

<script>
let all=[],view=[],wrong=new Set();
let i=0,preview=false,inWrong=false,hasProgress=false;

const $=id=>document.getElementById(id);

/* èœå• */
function toggleMenu(e){
  e.stopPropagation();
  $("menuList").classList.toggle("show");
}
document.addEventListener("click",()=>{
  $("menuList").classList.remove("show");
});

/* ------------------- é¢˜åº“å¯¼å…¥ ------------------- */
function toggleLoader(){
  $("loader").classList.toggle("hidden");
}

// é€šç”¨åŠ è½½å‡½æ•°
function loadFileContent(content, name){
  try{
    const data=JSON.parse(content);
    all=data.items.map((q,idx)=>({...q,_idx:idx}));
    view=all; i=0; wrong.clear(); hasProgress=false;
    $("loader").classList.add("hidden");
    $("fileName").textContent = name;
    render();
  }catch(e){
    alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š"+e.message);
  }
}

// æµè§ˆå™¨ç¯å¢ƒå¯¼å…¥
function browserFileImport(input){
  const f=input.files[0];
  if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>loadFileContent(reader.result, f.name);
  reader.readAsText(f);
}

// pakeplus åŸç”Ÿå¯¼å…¥
function pakeFileImport(){
  if(window.plus){
    plus.nativeUI.pickFile(files => {
      const f=files[0];
      f.file(fileEntry=>{
        fileEntry.file(file=>{
          const reader=new FileReader();
          reader.onload=()=>loadFileContent(reader.result, f.name);
          reader.readAsText(file);
        });
      });
    }, err=>{
      alert("æœªé€‰æ‹©æ–‡ä»¶");
    });
  }else{
    alert("é APK ç¯å¢ƒï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨æ–‡ä»¶é€‰æ‹©");
  }
}

// ç‚¹å‡»å¯¼å…¥é¢˜åº“æŒ‰é’®è°ƒç”¨
function importQuiz(){
  if(window.plus){
    pakeFileImport();
  }else{
    fileInput.click();
  }
}

/* ------------------- å¤ä¹ åŒ…å¯¼å…¥ ------------------- */
function importReview(){
  if(!window.plus){
    // æµè§ˆå™¨ç¯å¢ƒ
    reviewInput.click();
    return;
  }

  // æ‰‹æœº APK ç¯å¢ƒ
  plus.nativeUI.pickFile(
    files => {
      const f = files[0];
      f.file(fileEntry => {
        fileEntry.file(file => {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(reader.result);
              if (typeof data.currentIndex === "number") i = data.currentIndex;
              if (Array.isArray(data.wrongIndexes)) data.wrongIndexes.forEach(n => wrong.add(n));
              render();
              alert(`å¤ä¹ è¿›åº¦å·²æ¢å¤\næ–‡ä»¶ï¼š${f.name}`);
            } catch (e) {
              alert("å¤ä¹ åŒ…æ ¼å¼é”™è¯¯: " + e.message);
            }
          };
          reader.readAsText(file);
        });
      });
    },
    err => alert("æœªé€‰æ‹©å¤ä¹ åŒ…")
  );
}
/* ------------------- é¢˜å¹²è§£æ & å›¾ç‰‡ ------------------- */
function parseQuestionTitle(title) {
  const imgReg = /ã€å›¾ç‰‡ï¼š(.*?)ã€‘/g;
  return title.replace(imgReg,(m,url)=>`
    <div class="img-container">
      <button class="img-toggle-btn" onclick="toggleImage(this)">
        ğŸ“· ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡
      </button>
      <img src="${url}" class="question-img" hidden alt="é¢˜ç›®å›¾ç‰‡">
    </div>
  `);
}

function toggleImage(btn){
  const img=btn.nextElementSibling;
  const isHidden=img.hidden;
  img.hidden=!isHidden;
  btn.innerHTML = isHidden ? 'ğŸ“· æ”¶èµ·å›¾ç‰‡' : 'ğŸ“· ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡';
}

/* ------------------- æ¸²æŸ“ ------------------- */
function render(){
  const c=$("content");
  c.innerHTML="";
  if(!view.length){
    c.innerHTML="<div style='color:var(--muted)'>è¯·å…ˆå¯¼å…¥é¢˜åº“</div>";
    return;
  }
  if(preview){
    view.forEach((q,idx)=>{
      const parsedTitle=parseQuestionTitle(q.title);
      c.innerHTML+=`
        <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border)">
          <b>${idx+1}. ${parsedTitle}</b>
          ${q.options.map(o=>`<div style="margin:4px 0">${o.label}. ${o.text}</div>`).join("")}
          <div style="color:var(--ok); margin-top:8px">ç­”æ¡ˆï¼š${q.correctAnswer[0]}</div>
        </div>`;
    });
    return;
  }
  $("stats").textContent=
    `${inWrong?"é”™é¢˜":"å…¨éƒ¨"} ${i+1}/${view.length}ï½œé”™é¢˜ ${wrong.size}`;

  const parsedTitle=parseQuestionTitle(view[i].title);
  c.innerHTML=`<div class="question">${parsedTitle}</div>`;
  const opt=document.createElement("div"); opt.className="options";

  view[i].options.forEach(o=>{
    const d=document.createElement("div"); d.className="option";
    d.textContent=o.label+". "+o.text;
    d.onclick=()=>{
      hasProgress=true;
      document.querySelectorAll(".option").forEach(x=>x.classList.remove("correct","wrong"));
      if(o.text===view[i].correctAnswer[0]){
        d.classList.add("correct");
        if($("autoNext").checked)setTimeout(next,300);
      }else{
        d.classList.add("wrong");
        wrong.add(view[i]._idx);
        document.querySelectorAll(".option").forEach(opt=>{
          if(opt.textContent.includes(view[i].correctAnswer[0])){
            opt.classList.add("correct");
          }
        });
      }
    };
    opt.appendChild(d);
  });
  c.appendChild(opt);
}

/* ------------------- æ§åˆ¶ ------------------- */
function next(){ if(i<view.length-1){i++;render();} }
function prev(){ if(i>0){i--;render();} }
function toggleWrong(){
  inWrong=!inWrong;
  view=inWrong?[...wrong].map(n=>all[n]):all;
  i=0; render();
}
function togglePreview(){ preview=!preview; render(); }

/* ------------------- å¯¼å‡ºå¤ä¹ åŒ… ------------------- */
function exportReview(){
  if(!all.length){
    alert("è¯·å…ˆå¯¼å…¥é¢˜åº“");
    return;
  }

  // è·å–åŒ—äº¬æ—¶é—´
  const now = new Date();
  const beijingTime = new Date(now.getTime() + 8*60*60*1000); // UTC+8
  const pad = n => n.toString().padStart(2,'0');
  const timeStr = pad(beijingTime.getMonth()+1) + pad(beijingTime.getDate()) + pad(beijingTime.getHours()) + pad(beijingTime.getMinutes());

  // é¢˜åº“åç§°å»æ‰æ‰©å±•å
  const fileNameText = $("fileName").textContent.replace(/\.[^.]+$/,'');

  // æ„é€ å¯¼å‡ºæ–‡ä»¶å
  const exportName = `RE${timeStr}_${fileNameText}.txt`;

  // å¯¼å‡ºå†…å®¹
  const data = {
    currentIndex: i,
    wrongIndexes: [...wrong],
    time: beijingTime.toLocaleString('zh-CN', {hour12: false})
  };
  const content = JSON.stringify(data, null, 2);

  // æ‰‹æœº APK ç¯å¢ƒ
  if(window.plus){
    plus.io.requestFileSystem(plus.io.PUBLIC_DOCUMENTS, fs => {
      fs.root.getFile(exportName, {create:true}, fileEntry => {
        fileEntry.createWriter(writer => {
          writer.onwriteend = () => {
            alert(`å¤ä¹ åŒ…å·²å¯¼å‡ºåˆ° Documents æ–‡ä»¶å¤¹\næ–‡ä»¶åï¼š${exportName}`);
          };
          writer.onerror = err => {
            alert("å†™å…¥å¤±è´¥: " + err.message);
          };
          writer.write(content);
        }, err => alert("æ–‡ä»¶åˆ›å»ºå¤±è´¥: " + err.message));
      }, err => alert("è·å–æ–‡ä»¶å¤±è´¥: " + err.message));
    }, err => alert("æ–‡ä»¶ç³»ç»Ÿè¯·æ±‚å¤±è´¥: " + err.message));
  } else {
    // æµè§ˆå™¨ç¯å¢ƒå¤‡ç”¨
    const blob = new Blob([content], {type: "text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = exportName;
    a.click();
  }
}
/* ------------------- å¤œé—´æ¨¡å¼ ------------------- */
darkMode.onchange=e=>document.body.classList.toggle("dark",e.target.checked);
(function autoDark(){
  const h=new Date().getHours();
  if(h>=19||h<=6){
    document.body.classList.add("dark");
    $("darkMode").checked=true;
  }
})();
// é˜»æ­¢ç‚¹å‡»è¾“å…¥æ¡†æ”¶èµ·èœå•
const inputMenu = document.getElementById("jumpInputMenu");
if(inputMenu){
  inputMenu.addEventListener("click", e => e.stopPropagation());
  inputMenu.addEventListener("mousedown", e => e.stopPropagation());
}
/* ------------------- é¡µé¢å¸è½½æé†’ ------------------- */
window.addEventListener("beforeunload",e=>{
  if(hasProgress){ e.preventDefault(); e.returnValue=""; }
});
function jumpToMenu(){
  if(!all.length){
    alert("è¯·å…ˆå¯¼å…¥é¢˜åº“");
    return;
  }
  const val = parseInt(document.getElementById("jumpInputMenu").value);
  if(isNaN(val) || val < 1 || val > view.length){
    alert("è¯·è¾“å…¥æœ‰æ•ˆé¢˜å· (1-"+view.length+")");
    return;
  }
  i = val - 1; // æ•°ç»„ä»0å¼€å§‹
  render();
  // ä¸å…³é—­èœå•ï¼Œè¿™é‡Œä¸è°ƒç”¨ $("menuList").classList.remove("show");
}
/* ------------------- æ–‡ä»¶ input ç»‘å®š ------------------- */
fileInput.onchange=e=>browserFileImport(e.target);
reviewInput.onchange=e=>browserFileImport(e.target);
</script>
</body>
</html>